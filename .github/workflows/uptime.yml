on:
  schedule:
    - cron: '5-59/5 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Install jq
        run: sudo apt-get update -y && sudo apt-get install -y jq

      - name: Uptime check, compare and notify
        env:
          GCHAT_WEBHOOK: ${{ secrets.GCHAT_WEBHOOK }}
          SITES_FILE: sites.json
          STATUS_FILE: site-status.json
        run: |
          set -euo pipefail
          echo "Starting uptime check..."

          if [ ! -f "$SITES_FILE" ]; then
            echo "ERROR: $SITES_FILE not found."
            exit 1
          fi

          timestamp() { date -u +"%Y-%m-%dT%H:%M:%SZ"; }

          TMP_LINES=$(mktemp)
          TMP_NEW=$(mktemp)

          # Build new status list
          jq -c '.[]' "$SITES_FILE" | while read -r item; do
            url=$(echo "$item" | jq -r 'if type=="string" then . elif has("url") then .url elif has("site") then .site elif has("link") then .link else "" end')
            if [ -z "$url" ] || [ "$url" = "null" ]; then
              echo "Skipping invalid site entry: $item" >&2
              continue
            fi

            name=$(echo "$item" | jq -r 'if type=="object" and has("name") then .name else empty end' | sed -n '1p' || true)
            if [ -z "$name" ]; then name="$url"; fi

            code=$(curl -s -o /dev/null -w "%{http_code}" -m 15 "$url" || echo "000")
            ts=$(timestamp)
            echo "{\"url\":\"$url\",\"name\":\"$name\",\"status_code\":$code,\"timestamp\":\"$ts\"}" >> "$TMP_LINES"
          done

          jq -s '.' "$TMP_LINES" > "$TMP_NEW"
          rm -f "$TMP_LINES"

          if [ ! -f "$STATUS_FILE" ]; then
            echo "[]" > "$STATUS_FILE"
          fi

          CHANGES=""

          # âœ” FIXED: no subshell! using process substitution
          while read -r new; do
            url=$(echo "$new" | jq -r '.url')
            new_code=$(echo "$new" | jq -r '.status_code')

            old_code=$(jq -r --arg u "$url" '.[] | select(.url==$u) | .status_code' "$STATUS_FILE" 2>/dev/null || true)
            if [ -z "$old_code" ]; then old_code="(none)"; fi

            if [ "$new_code" != "$old_code" ]; then
              CHANGES="${CHANGES}${url}: ${old_code} -> ${new_code}\n"
            fi
          done < <(jq -c '.[]' "$TMP_NEW")

          echo "----- OLD STATUS -----"
          cat "$STATUS_FILE" || true
          echo "----- NEW STATUS -----"
          cat "$TMP_NEW" || true
          echo "----- CHANGE SUMMARY -----"
          if [ -z "$CHANGES" ]; then
            echo "No status changes."
          else
            echo -e "$CHANGES"
          fi

          # If changes: commit + push + notify
          if [ -n "$CHANGES" ]; then
            cp "$TMP_NEW" "$STATUS_FILE"

            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

            git add "$STATUS_FILE"

            if git diff --cached --quiet; then
              echo "No git changes? Unexpected."
            else
              git commit -m "chore: update site-status.json from uptime monitor"
              git push
            fi

            if [ -z "${GCHAT_WEBHOOK:-}" ]; then
              echo "GChat webhook missing; skipping notify."
            else
              MSG="Uptime changes detected:\n${CHANGES}"
              MSG=$(echo -e "$MSG" | head -c 8000)
              payload=$(jq -nc --arg t "$MSG" '{text:$t}')
              curl -s -X POST -H 'Content-Type: application/json' -d "$payload" "$GCHAT_WEBHOOK" || echo "Failed to notify GChat"
            fi
          fi

          rm -f "$TMP_NEW"
