name: Site monitor

on:
  schedule:
    - cron: '*/5 * * * *' 
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  check-sites:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Check sites and send notifications
        env:
          GCHAT_WEBHOOK: ${{ secrets.GCHAT_WEBHOOK }}
        run: |
          python3 - <<'PY'
          import json, os, urllib.request, subprocess, sys

          SITES_FILE = "sites.json"
          STATUS_FILE = "site-status.json"

          # Load sites.json
          try:
              with open(SITES_FILE, "r") as f:
                  sites = json.load(f)
          except Exception as e:
              print("ERROR: kon sites.json niet lezen:", e)
              sys.exit(1)

          # Load previous status
          prev = {}
          if os.path.exists(STATUS_FILE):
              try:
                  with open(STATUS_FILE, "r") as f:
                      prev = json.load(f)
              except Exception:
                  prev = {}

          new = dict(prev)
          changes = []

          for entry in sites:
              url = entry.get("url")
              if not url:
                  continue
              monitor = entry.get("monitor", True)
              if not monitor:
                  # skip sites die niet gemonitord moeten worden
                  continue
              try:
                  req = urllib.request.Request(url, method="HEAD")
                  resp = urllib.request.urlopen(req, timeout=10)
                  up = 200 <= resp.getcode() < 400
              except Exception:
                  up = False
              state = "up" if up else "down"
              old = prev.get(url)
              new[url] = state
              if old != state:
                  changes.append({"url": url, "from": old or "unknown", "to": state})

          # Zorg dat statusfile directory bestaat en schrijf nieuwe status
          dirpath = os.path.dirname(STATUS_FILE) or "."
          os.makedirs(dirpath, exist_ok=True)
          with open(STATUS_FILE, "w") as f:
              json.dump(new, f, indent=2)

          if not changes:
              print("Geen statuswijzigingen.")
              sys.exit(0)

          webhook = os.environ.get("GCHAT_WEBHOOK")
          if not webhook:
              print("GCHAT_WEBHOOK niet ingesteld (repo secret). Hieronder de wijzigingen:")
              for c in changes:
                  print(c)
              sys.exit(0)

          # Stuur melding per wijziging naar Google Chat webhook
          for c in changes:
              text = f"Site {c['url']} changed from {c['from']} to {c['to']}"
              payload = json.dumps({"text": text})
              subprocess.run([
                  "curl", "-s", "-X", "POST",
                  "-H", "Content-Type: application/json",
                  "-d", payload,
                  webhook
              ])
              print("Verstuurd melding:", text)
          PY

      - name: Commit status changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add site-status.json || true
          if git diff --staged --quiet; then
            echo "Geen wijzigingen om te committen."
          else
            git commit -m "Update site-status (door GitHub Actions)"
            git push
          fi
