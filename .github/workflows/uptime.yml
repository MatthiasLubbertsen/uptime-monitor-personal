on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Install jq
        run: sudo apt-get update -y && sudo apt-get install -y jq

      - name: Uptime check, compare and notify
        env:
          GCHAT_WEBHOOK: ${{ secrets.GCHAT_WEBHOOK }}
          SITES_FILE: sites.json
          STATUS_FILE: site-status.json
        run: |
          set -euo pipefail
          echo "Starting uptime check..."

          timestamp() { date -u +"%Y-%m-%dT%H:%M:%SZ"; }

          if [ ! -f "$SITES_FILE" ]; then
            echo "ERROR: $SITES_FILE not found."
            exit 1
          fi

          TMP_LINES=$(mktemp)
          TMP_NEW=$(mktemp)

          # Build new status entries
          jq -c '.[]' "$SITES_FILE" | while read -r item; do
            monitor=$(echo "$item" | jq -r 'if has("monitor") then .monitor else "true" end')

            if [ "$monitor" = "false" ]; then
              echo "Skipping (monitor=false): $item"
              continue
            fi

            url=$(echo "$item" | jq -r 'if type=="string" then . elif has("url") then .url elif has("site") then .site elif has("link") then .link else "" end')
            if [ -z "$url" ] || [ "$url" = "null" ]; then
              echo "Skipping invalid site entry: $item"
              continue
            fi

            name=$(echo "$item" | jq -r 'if has("name") then .name else "" end')
            if [ -z "$name" ] || [ "$name" = "null" ]; then name="$url"; fi

            code=$(curl -s -o /dev/null -w "%{http_code}" -m 15 "$url" || echo "000")
            ts=$(timestamp)

            echo "{\"url\":\"$url\",\"name\":\"$name\",\"status_code\":$code,\"timestamp\":\"$ts\"}" >> "$TMP_LINES"
          done

          jq -s '.' "$TMP_LINES" > "$TMP_NEW"
          rm -f "$TMP_LINES"

          if [ ! -f "$STATUS_FILE" ]; then
            echo "[]" > "$STATUS_FILE"
          fi

          CHANGES_FOUND="false"

          while read -r new; do
            url=$(echo "$new" | jq -r '.url')
            name=$(echo "$new" | jq -r '.name')
            new_code=$(echo "$new" | jq -r '.status_code')
            ts=$(echo "$new" | jq -r '.timestamp')

            old_code=$(jq -r --arg u "$url" '.[] | select(.url==$u) | .status_code' "$STATUS_FILE" || true)
            if [ -z "$old_code" ]; then old_code="(none)"; fi

            if [ "$new_code" != "$old_code" ]; then
              CHANGES_FOUND="true"

              alertType="NEUTRAL"
              if [ "$old_code" = "200" ] && [ "$new_code" != "200" ]; then
                alertType="BAD"
              elif [ "$old_code" != "200" ] && [ "$new_code" = "200" ]; then
                alertType="GOOD"
              fi

              msg=$(jq -nc \
                --arg name "$name" \
                --arg url "$url" \
                --arg old "$old_code" \
                --arg new "$new_code" \
                --arg ts "$ts" \
                --arg type "$alertType" \
                '
{
  cardsV2: [
    {
      cardId: "uptime-update",
      card: {
        header: {
          title: ("Status update: " + $name),
          subtitle: ($type + " | " + $ts)
        },
        sections: [
          {
            header: "Details",
            widgets: [
              { keyValue: { topLabel: "URL", content: $url }},
              { keyValue: { topLabel: "Old status", content: $old }},
              { keyValue: { topLabel: "New status", content: $new }}
            ]
          }
        ]
      }
    }
  ]
}
                ')

              if [ -n "${GCHAT_WEBHOOK:-}" ]; then
                curl -s -X POST -H 'Content-Type: application/json' -d "$msg" "$GCHAT_WEBHOOK" \
                  || echo "Failed to send to GChat"
              else
                echo "No GCHAT_WEBHOOK; skipping notification."
              fi
            fi

          done < <(jq -c '.[]' "$TMP_NEW")

          if [ "$CHANGES_FOUND" = "true" ]; then
            cp "$TMP_NEW" "$STATUS_FILE"

            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

            git add "$STATUS_FILE"

            if git diff --cached --quiet; then
              echo "No git changes? Unexpected."
            else
              git commit -m "chore: update site-status.json (uptime monitor)"
              git push
            fi
          else
            echo "No changes detected."
          fi

          rm -f "$TMP_NEW"
