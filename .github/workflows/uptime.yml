name: Uptime Monitor

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Install jq
        run: sudo apt-get update -y && sudo apt-get install -y jq

      - name: Run monitor
        env:
          GCHAT_WEBHOOK: ${{ secrets.GCHAT_WEBHOOK }}
        run: |
          set -euo pipefail

          SITES_FILE="sites.json"
          STATUS_FILE="site-status.json"

          if [ ! -f "$SITES_FILE" ]; then
            echo "ERROR: $SITES_FILE does not exist."
            exit 1
          fi

          timestamp() { date -u +"%Y-%m-%dT%H:%M:%SZ"; }

          TMP_NEW=$(mktemp)

          # Build new statuses
          jq -c '.[]' "$SITES_FILE" | while read -r item; do
            monitor=$(echo "$item" | jq -r 'if has("monitor") then .monitor else "true" end')
            if [ "$monitor" = "false" ]; then
              echo "Skipping (monitor=false): $item"
              continue
            fi

            url=$(echo "$item" | jq -r '
              if type=="string" then . 
              elif has("url") then .url
              elif has("site") then .site
              else "" end')

            [ -z "$url" ] && continue

            name=$(echo "$item" | jq -r 'if has("name") then .name else empty end')
            [ -z "$name" ] && name="$url"

            code=$(curl -s -o /dev/null -w "%{http_code}" -m 15 "$url" || echo "000")
            ts=$(timestamp)

            echo "{\"url\":\"$url\",\"name\":\"$name\",\"status_code\":$code,\"timestamp\":\"$ts\"}" >> "$TMP_NEW"
          done

          # Convert to array
          NEW_JSON=$(jq -s '.' "$TMP_NEW")
          rm "$TMP_NEW"

          [ ! -f "$STATUS_FILE" ] && echo "[]" > "$STATUS_FILE"

          OLD_JSON=$(cat "$STATUS_FILE")

          # Loop over new statuses
          echo "$NEW_JSON" | jq -c '.[]' | while read -r new; do
            url=$(echo "$new" | jq -r '.url')
            new_code=$(echo "$new" | jq -r '.status_code')
            name=$(echo "$new" | jq -r '.name')
            ts=$(echo "$new" | jq -r '.timestamp')

            old_code=$(echo "$OLD_JSON" | jq -r --arg u "$url" '
              .[] | select(.url==$u) | .status_code' || true)

            [ -z "$old_code" ] && old_code="(none)"

            if [ "$new_code" != "$old_code" ]; then

              # Icon select
              icon_for_code() {
                code="$1"
                if [ "$code" = "(none)" ] || [ "$code" = "000" ]; then
                  echo "BUG_REPORT"
                elif [ "$code" -ge 200 ] && [ "$code" -le 299 ]; then
                  echo "CHECK_CIRCLE"
                elif [ "$code" -ge 300 ] && [ "$code" -le 399 ]; then
                  echo "STAR"
                elif [ "$code" -ge 400 ] && [ "$code" -le 499 ]; then
                  echo "WARNING"
                elif [ "$code" -ge 500 ] && [ "$code" -le 599 ]; then
                  echo "ERROR"
                else
                  echo "STAR"
                fi
              }

              newIcon=$(icon_for_code "$new_code")
              oldIcon=$(icon_for_code "$old_code")

              # Build Google Chat card from template ------------------------
              msg=$(cat << EOF
{
  "cardsV2": [
    {
      "cardId": "uptime-update",
      "card": {
        "header": {
          "title": "$name",
          "subtitle": "$url",
          "imageUrl": "https://cdn-icons-png.flaticon.com/512/1827/1827504.png",
          "imageStyle": "AVATAR"
        },
        "sections": [
          {
            "header": "Status Update",
            "widgets": [
              {
                "decoratedText": {
                  "startIcon": {
                    "knownIcon": "$newIcon"
                  },
                  "text": "Nieuwe statuscode: <b>$new_code</b>"
                }
              },
              {
                "decoratedText": {
                  "startIcon": {
                    "knownIcon": "$oldIcon"
                  },
                  "text": "Vorige statuscode: $old_code"
                }
              },
              {
                "buttonList": {
                  "buttons": [
                    {
                      "text": "Open website",
                      "onClick": {
                        "openLink": {
                          "url": "$url"
                        }
                      }
                    }
                  ]
                }
              }
            ]
          }
        ]
      }
    }
  ]
}
EOF
)

              curl -s -X POST \
                -H "Content-Type: application/json" \
                -d "$msg" \
                "$GCHAT_WEBHOOK"

            fi
          done

          echo "$NEW_JSON" > "$STATUS_FILE"

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add "$STATUS_FILE"

          if ! git diff --cached --quiet; then
            git commit -m "chore: update uptime data"
            git push
          fi
